<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <link type="text/css" rel="stylesheet" href="css/calendar1.css">
    <link type="text/css" rel="stylesheet" href="css/main1.css">
    <link media="screen" rel="stylesheet" href="css/bootstrap.css" >
    <script src="http://code.jquery.com/jquery-latest.js"></script>

    <link rel="SHORTCUT ICON" href="images/i1.ico">
    <script src="js/bootstrap.js"></script>
    <script src="js/weekHours.js"></script>
    <script src="js/calendar.js"></script>
    <title>Резервирование конференц зала</title>
</head>
<body>

    <div id="main" class="container">
        <div class="navbar">
            <div class="navbar-inner">
                <ul class="nav">
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                            Выбор зала
                            <b class="caret"></b>
                        </a>
                        <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu" id="roomslist">
                        </ul>
                    </li>
                </ul>
                <span class="brand">Услуги резервирования</span>
            </div>
        </div>
        <div class="modal hide fade" id="auth-modal" >
            <div class="modal-body">
                <div class="row">
                    <div class="well span4 offset1">
                        <legend>Авторизируйтесь</legend>
                        <div class="alert alert-error">
                            <a class="close" href="#" data-dismiss="alert">x</a>Ошибка!
                        </div>
                        <form method="post" accept-charset="utf-8" id="logform">
                            <input type="text" class="span4" placeholder="Email address" name="username">
                            <input type="password" class="span4" placeholder="Password" name="password">
                            <button class="btn btn-block btn-success" type="submit" name="submit"
                                    onclick="authorize22()" data-dismiss="modal">Авторизоваться</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div id="greeting">
            <h3>
                Выберите конференцзал
            </h3>
        </div>

        <div id="myCarousel" class="carousel slide">
            <div class="carousel-inner">
                <div class="item active" >
                    <div id="carousel1"></div>
                </div>
                <div class="item">
                    <div id="carousel2" ></div>
                </div>
            </div>
            <a class="left carousel-control" href="#myCarousel" data-slide="prev" id="left-control">&lsaquo;</a>
            <a class="right carousel-control" href="#myCarousel" data-slide="next" id="right-control">&rsaquo;</a>
        </div>

        <div class="tabbable">
            <ul class="nav nav-tabs">
                <li class="active"><a href="#tab1" data-toggle="tab">Посмотреть на выбранную дату</a></li>
                <li><a href="#tab2" data-toggle="tab">Редактор правил</a></li>
                <li><a href="#tab3" data-toggle="tab">Посмотреть в этом месяце</a></li>
            </ul>
            <div class="tab-content">
                <div class="tab-pane active row" id="tab1">
                    <div class="span3 text-center">
                        <div id="value"></div>
                    </div>
                    <div class="span7 text-center">
                        <ul id="schedule">
                            <li>8:00</li>
                            <li>9:00</li>
                            <li>10:00</li>
                            <li>11:00</li>
                            <li>12:00</li>
                            <li>13:00</li>
                            <li>14:00</li>
                            <li>15:00</li>
                            <li>16:00</li>
                            <li>17:00</li>
                            <li>18:00</li>
                            <li>19:00</li>
                        </ul>
                    </div>
                    <div class="span2 text-center">
                            <button class="btn btn-warning" onclick="bookMeetingRoom();">Подтвердить</button>
                    </div>

                </div>
                <div class="tab-pane" id="tab2">
                    <div class="row">
                        <div class="span10 offset1 text-center" id="weekhours-holder">
                        </div>
                    </div>
                    <div class="row">
                        <div class="span2 offset10 text-center">
                                <button class="btn btn-warning" onclick="createRule();">Применить</button>
                        </div>
                    </div>
                </div>
                <div class="tab-pane" id="tab3">
                    <div id="month-list">Тут будет список</div>
                </div>
            </div>
        </div>

        <script>
            var storage = [];
            var roomsList;
            var currentRoom;
            var d = new Date();
            var calendar = new Calendar(d);
            var calendar2 = new Calendar(d);
            var weekHours = new WeekHours();

            $('#carousel1').append(calendar.getElement());
            $('#carousel2').append(calendar2.getElement());
            $('#auth-modal').modal('show');
            displayFirstDate();
            getRoomsList();

            $('.carousel').carousel({
                interval:false
            });

            $(calendar).on("select", function(e) {
                $('#value').html(e.value);
                highlightDays(calendar.getValue());
                highlightHours(calendar.getValue());
            });

            $(calendar2).on("select", function(e) {
                $('#value').html(e.value);
                highlightDays(calendar.getValue());
                highlightHours(calendar.getValue());
            });

            $('#roomslist').on("click", 'li', onLiClick);

            $('#weekhours-holder').prepend(weekHours.getElement())
                    .on('click', 'td:not(.day-names)', onClick);

            $('#schedule').on('click', 'li', onClick);

            $('#right-control').on('click', nextMonth);
            $('#left-control').on('click', prevMonth);

            function nextMonth(e) {
                setTimeout(function() {
                                        calendar.nextMonth();
                                        calendar2.nextMonth();
                                        initStorage();
                                        }, 400);

            }

            function prevMonth(e) {
                setTimeout(function() {
                                        calendar.previousMonth();
                                        calendar2.previousMonth();
                                        initStorage();
                                        }, 400);
            }

            function onLiClick(e) {
                currentRoom = $(e.target).html();
                $('#greeting').html('<h3>Добро пожаловать в ' + currentRoom + ' конференцзал</h3>');
                initStorage();
            }

            function initStorage() {
                $.ajax({
                    url:'/receive'
                    , type:'GET'
                    , data: {
                        room: currentRoom,
                        date: $('#value').html()
                    }
                    , success: function(res) {
                        storage = JSON.parse(res);
                        var index = getArrIndexByPropName(storage, 'date', 'rule');
                        if (index != -1) {
                            storage[index].hours = JSON.parse(storage[index].hours);
                        }
                        highlightDays(calendar.getValue());
                        highlightHours(calendar.getValue());
                        showRecordInMonth(storage, calendar.getValue());
                        highlightRule();
                    }
                    , error: function(res) {
                        alert('Here is some troubles with booking ');
                    }
                });
            }

            function authorize22() {
                //alert($('#logform').username);
                //alert($('#logform').password);
                $.ajax({
                    url:'/login'
                    , type:'POST'
                    , data: {
                        'username': '11',
                        'password': '222'
                    }
                    , success: function(res) {
                       alert(res);
                    }
                    , error: function(res) {
                        alert('Here is some troubles with booking 4444  ' + res.data);
                    }
                });
            }

            function onClick(e) {
                $(e.target).toggleClass("reserved");
            }

            function bookMeetingRoom() {
                if(!currentRoom) {
                    alert('Выберите, пожалуйста, конференцзал');
                    return false;
                }
                var value = $('#value').html();
                var times = [];
                var record = {};
                record.room = currentRoom;
                record.date = value;
                $('li').each(function(index, elem) {
                            if($(elem).hasClass('reserved')) {
                                times.push($(elem).html());
                            }
                        });
                record.hours = times;
                $.ajax({
                    url:'/save'
                    , type:'POST'
                    , data: {
                        'storage': JSON.stringify(record)
                    }
                    , success: function(res) {
                        var index = getArrIndexByPropName(storage, 'date', value);
                        if ( index == -1 ) {
                            if (times.length != 0) {
                                storage.push(record);
                            }
                        } else {
                            if (times.length == 0) {
                                storage.splice(index, 1);
                            } else {
                                storage[index].hours = times;
                            }
                        }

                        highlightDays(calendar.getValue());
                        highlightHours(calendar.getValue());
                        showRecordInMonth(storage, calendar.getValue());
                    }
                    , error: function(res) {
                        alert('Here is some troubles with booking ');
                    }
                });
            }

            function createRule() {
                if(!currentRoom) {
                    alert('Выберите, пожалуйста, конференцзал');
                    return false;
                }
                var dayNum;
                var weekTable = $('#weekhours-holder');
                var record = {};
                var rule = [];
                weekTable.find('.reserved')
                        .each(function(index, elem) {
                            var row = $(elem).parent();
                            var dayName = row.find('.day-names').html();
                            switch (dayName) {
                                case 'Пн':
                                    dayNum = 1;
                                    break;
                                case 'Вт':
                                    dayNum = 2;
                                    break;
                                case 'Ср':
                                    dayNum = 3;
                                    break;
                                case 'Чт':
                                    dayNum = 4;
                                    break;
                                case 'Пт':
                                    dayNum = 5;
                                    break;
                                case 'Сб':
                                    dayNum = 6;
                                    break;
                                case 'Вс':
                                    dayNum = 0;
                                    break;
                            }
                            var hour = weekTable.find('th').eq(row.find('td').index($(elem))).html();

                            if ( dayNum in rule ) {
                                rule[dayNum].push(hour);
                            } else {
                                rule[dayNum] = [];
                                rule[dayNum].push(hour);
                            }
                        });
                record.date = 'rule';
                record.hours = [JSON.stringify(rule)];
                record.room = currentRoom;
                $.ajax({
                    url:'/save'
                    , type:'POST'
                    , data: {
                        'storage': JSON.stringify(record)
                    }
                    , success: function(res) {
                        var index = getArrIndexByPropName(storage, 'date', 'rule');
                        if (index == -1) {
                            record.hours = rule;
                            storage.push(record);
                        } else {
                            storage[index].hours = rule;
                        }
                        highlightDays(calendar.getValue());
                        highlightHours(calendar.getValue());
                        showRecordInMonth(storage, calendar.getValue());
                    }
                    , error: function(res) {
                        alert('Here is some troubles with booking ');
                    }
                });
            }

            function highlightHours(currentDate) {
                var hourValuesStor;
                var value = $('#value').html();
                var rule = storage.rule;
                var hourValuesRule;
                var hourValues = [];
                for (var i = 0; i < storage.length; i++){
                    if(storage[i].date == value) {
                        hourValuesStor = storage[i].hours;
                        break;
                    }
                }
                var index = getArrIndexByPropName(storage, 'date', 'rule');

                if (index != -1) {
                    hourValuesRule = storage[index].hours[currentDate.getDay()%7];
                }

                if (hourValuesStor) {
                    hourValues = hourValues.concat(hourValuesStor);
                }

                if (hourValuesRule) {
                    hourValues = hourValues.concat(hourValuesRule);
                }

                var lis = $('li').toggleClass('reserved', false);
                if (hourValues) {
                    lis.each(function(index, elem) {
                                if (hourValues.indexOf($(elem).html()) != -1) {
                                    $(elem).addClass('reserved');
                                }
                            });
                }
            }

            function highlightDays(currentDate) {
                var dayValues = [];
                var dateFromStorage;
                var month = currentDate.getMonth();
                var year = currentDate.getFullYear();
                for(var i = 0; i < storage.length; i++) {
                    if(storage[i].date != 'rule') {
                        dateFromStorage = (storage[i].date).split('.');
                        if (dateFromStorage[1] == month + 1 && dateFromStorage[2] == year) {
                            dayValues.push(parseInt(dateFromStorage[0]).toString());
                        }
                    }
                }
                var index = getArrIndexByPropName(storage, 'date', 'rule');
                if (index != -1) {
                    currentDate.setDate(1);
                    var numDay;
                    while (currentDate.getMonth() == month) {
                        numDay = currentDate.getDay()%7;
                        if (storage[index].hours[numDay]) {
                            dayValues.push(currentDate.getDate() + '');
                        }
                        currentDate.setDate(currentDate.getDate() + 1);
                    }
                }
                var tds = $('.date-cell').toggleClass('reserved', false);
                if (dayValues) {
                    tds.each(function(index, elem) {
                        if(dayValues.indexOf($(elem).html()) != -1) {
                            $(elem).addClass('reserved');
                        }
                    });
                }
            }

            function highlightRule() {
                var weekTable = $('#weekhours-holder').find('tr');
                var ths = weekTable.eq(0).find('th');
                var index = getArrIndexByPropName(storage, 'date', 'rule');
                if (index != -1) {
                    var rule = storage[index].hours;
                    for (var i = 0; i < rule.length; i++) {
                        if(rule[i]) {
                            if( i == 0 ) {
                                var tds = weekTable.eq(7).find('td');
                            } else {
                                tds = weekTable.eq(i).find('td');
                            }
                            ths.each(function(index, elem) {
                                if (rule[i].indexOf($(elem).html()) != -1) {
                                    tds.eq(index).addClass('reserved');
                                }
                            });
                        }
                    }
                }
            }

            function getRoomsList() {
                $.ajax({
                    url:'/rooms'
                    , type:'GET'
                    , data:'jsonData'
                    , success: function(res) {
                        roomsList = res;
                        var divForRoom = $('<div></div>');
                        for (var i = 0; i < res.length; i++) {
                            divForRoom.append($('<li><a tabindex="-1">' + res[i] + '</a></li>'));
                        }
                        $('#roomslist').append(divForRoom.html());
                    }
                    , error: function(res) {
                        alert('Here is some troubles with booking ');
                    }
                });
            }

            function displayFirstDate() {
                var day = d.getDate();
                var month = d.getMonth() + 1;
                var year = d.getFullYear();
                $('#value').html(((day < 10) ? '0' + day : day) + '.' + ((month < 10) ? '0' + month : month) + '.' + year);
            }

            function getArrIndexByPropName (arr, propName, value){
                for(var i = 0; i < arr.length; i++) {
                    if(arr[i][propName] == value) {
                        return i;
                    }
                }
                return -1;
            }

            function showRecordInMonth(arr, currentDate) {
                var ulForRec = $('<ul></ul>');
                var dayValues = [];
                var obj = {};
                var dayResult = [];
                var month = currentDate.getMonth();
                var year = currentDate.getFullYear();
                var index = getArrIndexByPropName(storage, 'date', 'rule');
                if (index != -1) {
                    currentDate.setDate(1);

                    while (currentDate.getMonth() == month) {
                        (function(d) {
                            var numDay;
                            var currentRec = {};
                            numDay = d.getDay()%7;
                            if (storage[index].hours[numDay]) {
                                currentRec.date = (d.getDate() < 10 ? ('0' + d.getDate()) : d.getDate()) +
                                        '.' + (month < 9 ? '0' + (month + 1) : (month + 1)) + '.' + year;
                                currentRec.hours = storage[index].hours[numDay];
                                dayValues.push(currentRec);
                            }
                        })(currentDate);
                        currentDate.setDate(currentDate.getDate() + 1);
                    }
                }
                outer:
                for (var i = 0; i < arr.length; i++) {
                    for (var j = 0; j < dayValues.length; j++) {

                        if ( arr[i].date == dayValues[j].date ) {
                            dayValues[j].hours = dayValues[j].hours.concat(arr[i].hours);

                            for ( var k = 0; k < dayValues[j].hours.length; k++) {
                                obj[dayValues[j].hours[k]] = 1;
                            }
                            dayValues[j].hours = Object.keys(obj).sort(compareHours);
                            continue outer;
                        }
                    }
                    if(arr[i].date != 'rule') {
                        dayValues.push(arr[i]);
                    }
                }
                dayValues.sort(compareRecordsInArray);
                for ( i = 0; i < dayValues.length; i++) {
                    ulForRec.append($('<li>' + dayValues[i].date +'_______' + dayValues[i].hours.join(', ') + '</li>'));
                }
                if (dayValues.length == 0) {
                    $('#month-list').html('В этом месяце нет зарезервированного времени');
                } else {
                    $('#month-list').html('В этом месяце есть резервирования на следующие даты и часы').append(ulForRec);
                }
            }

            function compareHours(a, b) {
                if(parseInt(a) > parseInt(b)) return 1;
                if(parseInt(a) < parseInt(b)) return -1;
            }

            function compareRecordsInArray(a,b) {
                if(a.date > b.date) return 1;
                if(a.date < b.date) return -1;
            }

        </script>
    </div>
</body>
</html>